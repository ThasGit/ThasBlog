<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="ThasBlog">
<meta property="og:url" content="http://thas.cc/index.html">
<meta property="og:site_name" content="ThasBlog">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ThasBlog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://thas.cc/">





  <title>ThasBlog</title>
  








<link rel="stylesheet" href="/css/prism-base16-ateliersulphurpool.light.css" type="text/css"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ThasBlog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/06/05/novnc配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/05/novnc配置/" itemprop="url">novnc配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-05T22:10:31+08:00">
                2019-06-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/05/16/树莓派-Debian禁用IPv6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/16/树莓派-Debian禁用IPv6/" itemprop="url">树莓派/Debian禁用IPv6</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-16T19:29:01+08:00">
                2019-05-16
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/玩机技巧/" itemprop="url" rel="index">
                    <span itemprop="name">玩机技巧</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="使用sysctl命令禁用IPv6"><a href="#使用sysctl命令禁用IPv6" class="headerlink" title="使用sysctl命令禁用IPv6"></a>使用<code>sysctl</code>命令禁用IPv6</h2><p>修改<code>/etc/sysctl.conf</code>文件，添加如下语句：</p>
<pre><code># disable IPv6
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
</code></pre><p>立即生效：<code>sudo sysctl -p</code></p>
<h2 id="使用grub"><a href="#使用grub" class="headerlink" title="使用grub"></a>使用<code>grub</code></h2><p>修改<code>/etc/default/grub</code>文件，将<code>ipv6.disable=1</code>添加到<code>GRUB_CMDLINE_LINUX</code>这一行。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/04/18/springboot——源码初探/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/18/springboot——源码初探/" itemprop="url">springboot-源码初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-18T16:34:03+08:00">
                2019-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="对springboot的理解"><a href="#对springboot的理解" class="headerlink" title="对springboot的理解"></a>对springboot的理解</h2><p>springboot是一个基于约定大于配置理念的整合框架，可以以最少的（手动）配置文件快速构建和启动项目，这并不是说框架中就没有配置文件，而是默认的配置文件都整个到了类似<code>boot-starter</code>格式的jar包中，一般情况下不再需要开发者手动去覆盖配置了。springboot除了针对自家的框架推出了<code>starter</code>的快速启动方案之外，还约定了一套便于其他非spring框架整合进springboot的规范，知名的比如<code>mybatis-spring-boot-starter</code>就是按该规范整合进了springboot框架（该快速启动框架不是spring开发的，spring只提供了规范）。</p>
<h2 id="spring-boot-starter启动入口"><a href="#spring-boot-starter启动入口" class="headerlink" title="spring-boot-starter启动入口"></a>spring-boot-starter启动入口</h2><p>本质上需要创建一个<code>SpringApplication</code>对象，并调用run方法开始执行。有两种方式创建：</p>
<ol>
<li>使用该对象提供的静态方法<code>run</code>：<pre class=" language-java"><code class="language-java"> <span class="token keyword">public</span> <span class="token keyword">static</span> ConfigurableApplicationContext <span class="token function">run</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> primarySource<span class="token punctuation">,</span> String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span>primarySource<span class="token punctuation">}</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 <span class="token keyword">public</span> <span class="token keyword">static</span> ConfigurableApplicationContext <span class="token function">run</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> primarySources<span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span>primarySources<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
</li>
<li>使用<code>SpringApplicationBuilder</code>：<pre class=" language-java"><code class="language-java"> <span class="token keyword">new</span> <span class="token class-name">SpringApplicationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> primarySource<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>String<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">protected</span> SpringApplication <span class="token function">createSpringApplication</span><span class="token punctuation">(</span>Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> sources<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplication</span><span class="token punctuation">(</span>sources<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
</li>
</ol>
<p>最核心的是要提供<code>primarySource</code>，其实就是基于该类所在的包扫描spring注解，命令行的启动参数也可以传递给run方法，用作spring的启动参数。<code>SpringApplicationBuilder</code>要比静态方法run灵活许多。</p>
<p>再来说说非静态的run方法，也就是springboot启动的主要过程：</p>
<ol>
<li>该方法需要得到一个<code>ConfigurableApplicationContext</code>类型的对象，springboot应用并不一定就是web应用。</li>
<li>扫描启动参数中提供的<code>SpringApplicationRunListeners</code>，spring的监听器是伴随spring的声明周期的，分为starting和started两个步骤：<pre class=" language-java"><code class="language-java"> <span class="token keyword">private</span> SpringApplicationRunListeners <span class="token function">getRunListeners</span><span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> types <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> SpringApplication<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SpringApplicationRunListeners</span><span class="token punctuation">(</span>logger<span class="token punctuation">,</span> <span class="token function">getSpringFactoriesInstances</span><span class="token punctuation">(</span>
             SpringApplicationRunListener<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> types<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
</li>
<li>转换启动参数args和启动环境（包含配置文件），紧接着是一个spring的banner（(⊙o⊙)…）。</li>
<li>然后就<code>createApplicationContext()</code>创建应用上下文了（空的），其中区分了普通servlet类型、reactive类型和非web类型，当然也可以提供自定义的<code>applicationContext</code>:<pre class=" language-java"><code class="language-java"> <span class="token keyword">protected</span> ConfigurableApplicationContext <span class="token function">createApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span> contextClass <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>applicationContextClass<span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>contextClass <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">try</span> <span class="token punctuation">{</span>
             <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webApplicationType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">case</span> SERVLET<span class="token operator">:</span>
                 contextClass <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>DEFAULT_SERVLET_WEB_CONTEXT_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
             <span class="token keyword">case</span> REACTIVE<span class="token operator">:</span>
                 contextClass <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>DEFAULT_REACTIVE_WEB_CONTEXT_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">break</span><span class="token punctuation">;</span>
             <span class="token keyword">default</span><span class="token operator">:</span>
                 contextClass <span class="token operator">=</span> Class<span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>DEFAULT_CONTEXT_CLASS<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span>
                     <span class="token string">"Unable create a default ApplicationContext, "</span>
                             <span class="token operator">+</span> <span class="token string">"please specify an ApplicationContextClass"</span><span class="token punctuation">,</span>
                     ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span>
     <span class="token keyword">return</span> <span class="token punctuation">(</span>ConfigurableApplicationContext<span class="token punctuation">)</span> BeanUtils<span class="token punctuation">.</span><span class="token function">instantiateClass</span><span class="token punctuation">(</span>contextClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre>
</li>
<li>接下去<code>prepareContext(context, environment, listeners, applicationArguments,printedBanner);</code>填充应用上下文，然后刷新应用上下文（初始化<code>BeanFactory</code>），自动配置类的注入是在这个步骤中实现的。</li>
<li>最后是监听器的started方法，以及执行自定义的一些runner。</li>
<li>整个过程如果发生异常，则会取消刷新过程，执行<h2 id="springboot自动配置规范"><a href="#springboot自动配置规范" class="headerlink" title="springboot自动配置规范"></a>springboot自动配置规范</h2>以<code>mybatis-spring-boot-starter</code>为例，依赖关系如下图：<br><img src="/2019/04/18/springboot——源码初探/20190505105239899_12478.png" alt="mybatis-spring-boot-starter依赖关系"></li>
</ol>
<p>核心的依赖便是主功能<code>mybatis</code>和快速配置相关的<code>spring-boot-starter</code>和<code>mybatis-spring-boot-autoconfigure</code>，<code>mybatis-spring</code>这个模块是为了使mybatis能够适配到spring框架，并不是springboot特有的，spring-mvc也会用到，比如<code>SqlSessionTemplate</code>和<code>MapperScanner</code>这个功能就是该模块提供的。</p>
<p>一般来说<code>starter</code>这个模块是不包含代码的，它只包括模块依赖（pom）、<code>MANIFEST.MF</code>（支持环境）。</p>
<p>然后跟自动配置相关的便是<code>mybatis-spring-boot-autoconfigure</code>，这个类中需要提供bean注入的配置类<code>Configuration</code>，当然，由于配置类需要扫描才能注入，显然现在并不符合这个条件。</p>
<p>因此，<code>spring-boot-autoconfigure</code>提供了一种机制，spring会通过<code>SpringFactoriesLoader</code>扫描<code>META-INF</code>下的<code>spring.factories</code>文件，通过其中定义<code>org.springframework.boot.autoconfigure.EnableAutoConfiguration</code>属性来加载自动配置的类。</p>
<p>因此springboot的自动配置依然是<code>Configuration</code>注解实现，只是绕了一点，通过<code>spring.factories</code>文件指定了该配置类的路径。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/04/07/spring-tx——事务传播行为/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/07/spring-tx——事务传播行为/" itemprop="url">spring-tx——事务传播行为</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-07T22:29:30+08:00">
                2019-04-07
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/实用框架/" itemprop="url" rel="index">
                    <span itemprop="name">实用框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>spring-tx共有7种事务传播行为：</p>
<ul>
<li>REQUIRED：（必须开启事务）如果事务已存在，加入当前事务；如果不存在，则新建一个事务。</li>
<li>SUPPORTS：（支持当前事务，可有可无）如果事务已存在，加入当前事务；如果不存在，忽略。</li>
<li>MANDATORY：（事务必须已经存在）如果当前不存在事务，抛出异常。</li>
<li>REQUIRED_NEW：（必须新建事务）不管当前是否已存在事务，新建一个事务。</li>
<li>NOT_SUPPROTED：（忽略事务）</li>
<li>NEVER：（禁止事务）如果当前已存在事务，抛出异常。</li>
<li>NESTED：（以子事务方式运行）如果当前已存在事务，以子事务方式运行；如果不存在，新建一个事务。</li>
</ul>
<p>区别：</p>
<ul>
<li>REQUIRED、SUPPORTS、MANDATORY特点：最多存在一个事务，只要其中某一步回滚，便会回滚至事务起点（即时异常在事务中捕获处理了，但是引发异常的方法会执行回滚操作，此时事务将会引发<code>UnexpectedRollbackException</code>异常，整个事务回滚）。</li>
<li>REQUIRED_NEW：独立事务，与已存在事务互不影响，只会使自身回滚起点。</li>
<li>NOT_SUPPROTED、NEVER：不存在事务，不会影响已存在的事务。</li>
<li>NESTED：建立安全点，子事务异常时，回滚至安全点，继续执行父事务，不影响父事务提交；但如果父事务回滚，则子事务也回滚（回滚至父事务起点）；</li>
</ul>
<p>注意点：</p>
<p>事务中非当前事务方法（NOT_SUPPROTED、NEVER非事务方法、NESTED子事务方法）造成引发回滚事件的异常，必须在事务内捕获，否则父事务（因为方法执行异常）压根不会正常执行到最后（提交），自然也不存在回滚。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/04/01/spring——IOC源码解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/01/spring——IOC源码解析/" itemprop="url">spring——IOC源码解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-01T22:05:00+08:00">
                2019-04-01
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="关键接口"><a href="#关键接口" class="headerlink" title="关键接口"></a>关键接口</h1><h2 id="Beanfactory"><a href="#Beanfactory" class="headerlink" title="Beanfactory"></a>Beanfactory</h2><p><code>org.springframework.beans.factory.Beanfactory</code>负责bean的提取，包含<code>getBean</code>的一系列重载方法。这个接口只负责输出bean。</p>
<pre class=" language-java"><code class="language-java">Object <span class="token function">getBean</span><span class="token punctuation">(</span>String name<span class="token punctuation">)</span> <span class="token keyword">throws</span> BeansException<span class="token punctuation">;</span>
</code></pre>
<h2 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h2><p><code>ApplicationContext</code>集成了多个接口，合成了一个管理应用上下文的接口，其继承结构如下图：</p>
<p><img src="/2019/04/01/spring——IOC源码解析/20190401191515499_17508.png" alt></p>
<ul>
<li><code>ResourcePatternResolver</code>用于解析资源路径的，比如<code>classpath*:</code>这种路径就是该接口负责解析。</li>
<li><code>MessageSource</code>用于读取配置文件信息，并且支持国际化。</li>
<li><code>ApplicationEventPublisher</code>事件发布器。将会将<code>ApplicationEvent</code>事件交给注解了容器中注解了<code>EventListener</code>的方法去处理。</li>
<li><code>EnvironmentCapable</code>用于获得应用上下文的环境，通常用于提供给那些接受了<code>BeanFactory</code>的方法，检查该工厂是否与自身匹配。</li>
</ul>
<h2 id="ConfigurableApplicationContext"><a href="#ConfigurableApplicationContext" class="headerlink" title="ConfigurableApplicationContext"></a>ConfigurableApplicationContext</h2><p><code>ConfigurableApplicationContext</code>继承了<code>ApplicationContext</code>和<code>Lifecycle</code>、<code>Closeable</code>，提供了对应用上下文声明周期的管理：</p>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//Lifecycle</span>
<span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> <span class="token function">isRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//Closeable</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException<span class="token punctuation">;</span>
</code></pre>
<p><code>ConfigurableApplicationContext</code>内部定义了设置环境、设置父应用上下文、注册后处理器、注册协议处理器、事件发布、注册事件监听器、注册应用关闭回调方法、获取<code>BeanFactory</code>等方法。</p>
<h2 id="Environment-ConfigurableEnvironment"><a href="#Environment-ConfigurableEnvironment" class="headerlink" title="Environment/ConfigurableEnvironment"></a>Environment/ConfigurableEnvironment</h2><p>用于获得环境变量，包括Java系统属性、Java环境变量和配置文件（Properties）中的变量。</p>
<h1 id="运作过程"><a href="#运作过程" class="headerlink" title="运作过程"></a>运作过程</h1><h2 id="ClassPathXmlApplicationContext"><a href="#ClassPathXmlApplicationContext" class="headerlink" title="ClassPathXmlApplicationContext"></a>ClassPathXmlApplicationContext</h2><p>以<code>ClassPathXmlApplicationContext</code>为例：</p>
<ol>
<li>构造方法中传入xml配置文件的路径。</li>
<li>构造过程会调用<code>setConfigLocations</code>方法，调用<code>ConfigurableEvnironment</code>中的解析器去解析提供的路径（解析其中的SpEl表达式，获得最终需要解析的路径。如果环境不存在，将会立即创建一个<code>StandardEnvironment</code>）。</li>
<li>设置完成之后，立即调用<code>refresh()</code>方法，根据配置文件刷新应用上下文。<code>refresh()</code>方法中调用<code>obtainFreshBeanFactory()</code>方法创建<code>BeanFactory</code>。如果<code>BeanFactory</code>已经被创建，则会先销毁原先创建的。准备一个新的<code>DefaultListableBeanFactory</code>，并挂载到应用上下文内部（装饰器模式）。</li>
<li>创建工厂的过程中会执行<code>loadBeanDefinitions()</code>方法，使用<code>XmlBeanDefinitionReader</code>读取xml中的bean的配置，将bean的名称和类型信息添加到<code>BeanFactory</code>中去，这时候并没有做实例化工作。</li>
<li>然后对<code>BeanFactory</code>做一下初始化工作，绑定各种属性，执行后处理器，然后还要再执行bean定义的实例化后的操作：</li>
</ol>
<pre class=" language-java"><code class="language-java"><span class="token comment" spellcheck="true">//工厂初始化工作，绑定各种属性</span>
<span class="token function">prepareBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//工厂创建完成之后的操作</span>
<span class="token function">postProcessBeanFactory</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//执行factory的后处理器（不是bean的）</span>
<span class="token function">invokeBeanFactoryPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//注册bean中定义的processor</span>
<span class="token function">registerBeanPostProcessors</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Initialize message source for this context.</span>
<span class="token function">initMessageSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Initialize event multicaster for this context.</span>
<span class="token function">initApplicationEventMulticaster</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Initialize other special beans in specific context subclasses.</span>
<span class="token function">onRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Check for listener beans and register them.</span>
<span class="token function">registerListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 执行bean的声明周期的操作</span>
<span class="token function">finishBeanFactoryInitialization</span><span class="token punctuation">(</span>beanFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// Last step: publish corresponding event.</span>
<span class="token function">finishRefresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p><code>finishBeanFactoryInitialization()</code>过程中将会创建单例模式的bean。</p>
<p>Bean的生命周期，实例化-&gt;<code>BeanNameAware</code>-&gt;<code>BeanFactoryAware</code>-&gt;<code>ApplicaiontContextAware</code>-&gt;<code>BeanPostProcessor</code>前置方法-&gt;<code>InitializingBean</code>-&gt;<code>BeanPostProcessor</code>后置方法。<code>DisposableBean</code>销毁方法将在执行<code>ApplicationContext.close()</code>方法时执行。</p>
<h2 id="AnnotationConfigApplicationContext"><a href="#AnnotationConfigApplicationContext" class="headerlink" title="AnnotationConfigApplicationContext"></a>AnnotationConfigApplicationContext</h2><p><code>AnnotationConfigApplicationContext</code>与xml方式有差别，绑定bean的配置信息的操作不在<code>obtainFreshBeanFactory()</code>中进行<code>load</code>。注解扫描范围需要有<code>Configuration</code>来指定<code>ComponentScan</code>。<code>AnnotationConfigApplicationContext</code>将注解方式的bean的信息读取工作交给了做成了工厂后处理器<code>ConfigurationClassPostProcessor</code>，并由<code>ConfigurationClassParser</code>来解析。在执行<code>invokeBeanFactoryPostProcessors(beanFactory)</code>，对注解进行扫描。原型模式将不会有这样的声明周期，只负责实例化并交给用户。</p>
<h2 id="再来说说bean的实例化过程。"><a href="#再来说说bean的实例化过程。" class="headerlink" title="再来说说bean的实例化过程。"></a>再来说说bean的实例化过程。</h2><p>bean的作用域可以有singleton、prototype两种，只有单例模式的bean在<code>ApplicationContext</code>创建过程中去创建的。创建bean的过程会调用<code>getBean</code>方法，bean的实例化放在了getBean方法中。如果一个bean的构造方法参数依赖了另一个bean，那么会先暂停这个bean的创建过程，转而去执行另一个bean的创建过程。如果只是属性依赖，那么将会先完成当前bean的实例化过程，再去创建依赖的bean，然后注入给属性。因此构造方法参数循环依赖，将会造成栈溢出的问题，因为双方都没有实例化完成，会不断的去尝试创建彼此的实例。</p>
<h2 id="WebApplicationContext-ConfigurableWebApplicationContext"><a href="#WebApplicationContext-ConfigurableWebApplicationContext" class="headerlink" title="WebApplicationContext/ConfigurableWebApplicationContext"></a>WebApplicationContext/ConfigurableWebApplicationContext</h2><p><code>WebApplicationContext</code>继承自<code>ApplicationContext</code>，加入了request、session作用域（最新版本源码没有看到global session），并且支持挂载和获取<code>ServletContext</code>、<code>ServletConfig</code>。</p>
<p><code>ConfigurableWebApplicationContext</code>继承了原先的<code>ConfigurableApplicationContext</code>和<code>WebApplicationContext</code>。加入了<code>WebApplicationContext</code>的配置操作。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><code>BeanFactory</code>是具有工厂功能的接口，其功能比较单一，就是生产bean。</li>
<li><code>ApplicationContext</code>是spring的核心，其除了能够生产bean，还引入了bean的作用域和声明周期管理，还有资源路径解析、系统环境获取、国际化支持、事件发布等功能。</li>
<li><code>WebApplicationContext</code>在<code>ApplicationContext</code>的基础上加入了web的支持，扩展了<code>request</code>和<code>session</code>作用域，并能够保存servlet应用上下文和配置。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/03/28/什么是OR-Mapping/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/28/什么是OR-Mapping/" itemprop="url">什么是OR/Mapping</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-28T22:15:04+08:00">
                2019-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/实用框架/" itemprop="url" rel="index">
                    <span itemprop="name">实用框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ORM全称为“Object Relational Mapping”，对象关系映射，是一种程序技术，用于实现面向对象编程语言中不同类型的数据转换。</p>
<p>现在大部分情况下指的是数据库数据结构和程序语言中的数据结构之间的转换。数据库中数据表的字段与Java POJO类的字段创建映射关系，使数据表的数据能够根据映射关系转换为Java语言中的数据；反之，Java中的数据也能通过OR/Mapping技术保存到数据表中，即实现数据持久化。OR/Mapping技术被广泛应用各大著名的持久层框架中，比如<a href="/2019/03/28/mybatis——基础/" title="mybatis">mybatis</a>和微软的entityframework。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/03/28/mybatis——基础/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/28/mybatis——基础/" itemprop="url">mybatis——基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-28T22:13:39+08:00">
                2019-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/实用框架/" itemprop="url" rel="index">
                    <span itemprop="name">实用框架</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>mybatis是一款优秀的持久层框架，也是一款优秀的<a href="/2019/03/28/什么是OR-Mapping/" title="OR/Mapping">OR/Mapping</a>框架。其前身为ibatis，源码的包名依然是<code>org.apache.ibatis</code>。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>使用mybatis的基本步骤：</p>
<ol>
<li>创建<code>org.apache.ibatis.mapping.Environment</code>对象，即mybatis环境，主要是配置数据源。可以构建多个不同版本的环境，比如开发环境和正式环境，但是只会有一个环境可以被生效。构建<code>Environment</code>对象需要传入事务工厂<code>org.apache.ibatis.transaction.Transaction</code>和数据源<code>javax.sql.DataSource</code>。mybatis对着两者做了默认的实现，可以用如下语句创建：<pre class=" language-java"><code class="language-java"> TransactionFactory transactionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTransactionFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 PooledDataSource dataSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PooledDataSource</span><span class="token punctuation">(</span><span class="token string">"com.mysql.cj.jdbc.Driver"</span><span class="token punctuation">,</span> <span class="token string">"jdbc:mysql://localhost/table"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 Environment environment <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Environment</span><span class="token punctuation">(</span><span class="token string">"environment1"</span><span class="token punctuation">,</span> transactionFactory<span class="token punctuation">,</span> dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
 为了可以集成到spring框架，另外写了一个mybatis-spring插件，其中有spring对<code>TransactionFactory</code>的实现，使mybatis能够使用spring的事务管理器。</li>
<li>创建<code>Configuration</code>对象，指定使用一个<code>Environment</code>，添加需要使用的mapper映射类。可以指定具体的类的Class对象，也可以指定mapper对象所在的命名空间，此时会同时检索该命名空间下的mapper-xml配置和mapper-annotation配置。<pre class=" language-java"><code class="language-java"> Configuration configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Configuration</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
 configuration<span class="token punctuation">.</span><span class="token function">addMapper</span><span class="token punctuation">(</span>UserDAO<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 configuration<span class="token punctuation">.</span><span class="token function">addMappers</span><span class="token punctuation">(</span><span class="token string">"thas.dao"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
 所有的数据库的操作封装在了mapper对象中，mapper由数据库查询语句，参数，参数映射工具，查询结果映射工具构成。实际上，mapper本质上是构建<code>java.sql.PreparedStatement</code>对象，然后设置了参数的映射操作和查询结果的映射操作，使开发人员的开发工作简化。mapper可以使用xml或者注解进行创建。<ul>
<li>使用xml创建mapper：<ul>
<li>可以创建与之匹配的DAO层的接口，此时，xml的命名空间必须是该接口的全限定名，其中select、update等操作的id必须和该接口中的方法名对应上。</li>
<li>也可以不跟DAO层相关联，只是此时<code>SqlSession</code>不能再创建一个DAO层的实现来方便的进行操作，必须使用如下形式，使用id去调用操作。<pre class=" language-java"><code class="language-java">  Long count <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">selectOne</span><span class="token punctuation">(</span><span class="token string">"countByUsernameAndPassword"</span><span class="token punctuation">,</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ul>
</li>
<li>使用代码注解：<br>  将mapper直接配置在对应的DAO层接口上，就不用再额外创建mapper的xml文件了。类上注解Mapper声明该接口为mapper配置，在spring框架中，将使用<code>MapperFactoryBean</code>实现该接口，注入到容器中。select、update等操作以注解<code>@Select</code>、<code>@Update</code>等形式注解对应的方法声明上。</li>
</ul>
</li>
<li>使用<code>org.apache.ibatis.session.SqlSessionFactoryBuilder</code>创建<code>SqlSessionFactory</code>会话工厂，实际上是建立在数据源或线程池上的一层数据源抽象层。<pre class=" language-java"><code class="language-java">  SqlSessionFactory sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
 可以使用前两步构建的<code>Configuration</code>对象来创建工厂，也可以使用XML文件。<pre class=" language-java"><code class="language-java"> InputStream mybatisXml <span class="token operator">=</span> <span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"mybatis.xml"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 SqlSessionFactory sqlSessionFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionFactoryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>mybatisXml<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-xml"><code class="language-xml"> <span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?></span>
 <span class="token doctype">&lt;!DOCTYPE configuration
         PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
         "http://mybatis.org/dtd/mybatis-3-config.dtd"></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>db.properties<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environments</span> <span class="token attr-name">default</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>environment2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>environment</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>environment2<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>transactionManager</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>JDBC<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dataSource</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>POOLED<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>driver<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${driver}<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${url}<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${username}<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
                 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>${password}<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
             <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dataSource</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environment</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>environments</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mappers</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>mapper</span> <span class="token attr-name">resource</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>thas/dao/UserMapper.xml<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>mappers</span><span class="token punctuation">></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li>获取<code>org.apache.ibatis.session.SqlSession</code>对象，指定mapper进行数据库操作。<br> mybatis以<code>SqlSession</code>为基本单位对数据库进行操作。<code>SqlSession</code>即数据库会话，类似于<code>Connection</code>连接，一次会话可以执行多个操作，或者组成事务，但是其本身仅仅只是供用户调用的一层抽象。<code>SqlSession</code>使用<code>org.apache.ibatis.executor.Excutor</code>去执行数据库的操作。开发过程中，可以通过<code>SqlSession</code>构建DAO层接口的实现，很方便的进行数据库的操作。整合到spring框架中也是类似的原理，自动将DAO层的实现注入到容器中，但是<code>SqlSession</code>是线程不安全的，通过它构造出来的mapper也是线程不安全的，因此mybatis-spring构建了<code>SqlSessionTemplate</code>来支持线程安全，其本质是对<code>SqlSession</code>的包装/代理，模拟<code>SqlSession</code>的操作，但每次操作其实都是从会话工厂重新获得一个<code>SqlSession</code>。<pre class=" language-java"><code class="language-java"> <span class="token comment" spellcheck="true">//线程不安全</span>
 SqlSession sqlSession <span class="token operator">=</span> sqlSessionFactory<span class="token punctuation">.</span><span class="token function">openSession</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 UserDAO userDAO <span class="token operator">=</span> sqlSession<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>UserDAO<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token keyword">int</span> count <span class="token operator">=</span> userDAO<span class="token punctuation">.</span><span class="token function">countByUsernameAndPassword</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment" spellcheck="true">//线程安全</span>
 SqlSession sqlSessionTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SqlSessionTemplate</span><span class="token punctuation">(</span>sqlSessionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
 UserDAO userDAO <span class="token operator">=</span> sqlSessionTemplate<span class="token punctuation">.</span><span class="token function">getMapper</span><span class="token punctuation">(</span>UserDAO<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/03/28/mysql时区问题/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/28/mysql时区问题/" itemprop="url">mysql时区问题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-28T16:29:16+08:00">
                2019-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/开发经验/" itemprop="url" rel="index">
                    <span itemprop="name">开发经验</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>MySQL的时间表示法默认为CST。</p>
<p>时间表示法常用的用GMT、UTC和CST。</p>
<ul>
<li>GMT是格林威治标准时间，早些年是比较流行的。GMT表示的0时区的时间，GMT+8表示东八区时间，GMT-8:30（或GMT-830）表示西八点半区。</li>
<li>UTC是世界协调时间，同样代表的是0时区时间，与GMT表示法相比，更加精确，误差不超过0.9秒。</li>
<li>CST是UTC表示的时区缩写，但是其可以代表四个时区：<ul>
<li>美国中部时间UT-6:00</li>
<li>中国标准时间UT+8:00</li>
<li>古巴标准时间UT-4:00</li>
<li>澳大利亚中部时间:UT+9:30</li>
</ul>
</li>
</ul>
<p>因此MySQL默认使用的CST时区在不同的操作系统中所代表的的真实时间是不同的，在某些原生的Linux系统中，默认表示的是美国中部时间。因此你有可能会发现，你保存了一个时间，但是去数据库一看，比期望的时间少了14个小时，这其中的时差就是美国中部时间和中国标准时间的时差。</p>
<p>MySQL中的datetime类型与时区是无关，其内部保存的是相距格林威治标准时间1970-01-01 00:00:00的时间戳，所有将该时间戳选择合适的时区表示法都可以正确表示出来。</p>
<p>真正的问题发生在datetime类型数据的保存过程中。mysql执行insert插入数据，必须使用时间的字符串形式进行保存：</p>
<pre class=" language-sql"><code class="language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t <span class="token punctuation">(</span> time <span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span> <span class="token string">'1971-01-01 00:00:00'</span> <span class="token punctuation">)</span>
</code></pre>
<p>同样一个datetime时间戳，在不同时区看来其字符串形式是不一样的。反过来说，同样的一个字符串，在不同时区看来其保存的时间戳是不一样的。</p>
<p>因此执行SQL语句的客户端需要跟MySQL的时区保证一致才能正确的保存时间。为了保证这个一致性，通常不修改数据库的时区表示，而是在MySQL连接字符串中指定与数据库的连接会话过程所使用的时区：</p>
<pre><code>jdbc:mysql://localhost:3306/database?serverTimezone=GMT%2B08%3A00
</code></pre><p>需要注意的是，连接字符串是URL形式，其中的字符必须符合URL规范，敏感字符”+“和”:“需要使用URLencode进行编码，”+“用<code>%2B</code>表示，”:“用<code>%3A</code>表示，冒号可以省略不写。只有GMT可以指定时区，CST和UTC都是不带时区的。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/03/27/spring-mvc——源码初探/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/27/spring-mvc——源码初探/" itemprop="url">spring-mvc——源码初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-27T17:03:07+08:00">
                2019-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="spring-mvc原理"><a href="#spring-mvc原理" class="headerlink" title="spring-mvc原理"></a>spring-mvc原理</h1><h2 id="通过配置文件启动"><a href="#通过配置文件启动" class="headerlink" title="通过配置文件启动"></a>通过配置文件启动</h2><p>spring-mvc的核心是<code>org.springframework.web.servlet.DispatcherServlet</code>。通过tomcat将“/”映射到<code>DispatcherServlet</code>上，由spring-mvc分发URL。</p>
<pre class=" language-xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>springmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">></span></span>com.thas.spring.config.MyDispatcher<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">></span></span>contextConfigLocation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">></span></span>classpath:applicationContext.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">></span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>springmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span>
</code></pre>
<p><code>url-pattern</code>设置为“/”代表，tomcat不能识别的URL将全部交由<code>DispatcherServlet</code>来处理。其实就是将原本由tomcat来承担URL分发责任交给了<code>DispatcherServlet</code>。指定contextConfigLocation，用于初始化spring应用上下文，如果不设置的话，会自动搜寻WEB-INF下以application开头或以context结尾的xml文件。由于<code>DispatcherServlet</code>初始化过程中需要初始化spring应用上下文和挂载servletContext，因此最好设置load-on-start，提前做好耗时的初始化工作。</p>
<p>由于jsp会被翻译成servlet，由tomcat自动映射jsp文件路径和jsp代表的servlet，因此jsp请求不会交给spring去处理。除此之外，都会交给<code>DispatcherServlet</code>，包括静态资源文件。因此需要对静态资源文件做放行操作：</p>
<ol>
<li>在web.xml中放行，由tomcat的默认servlet处理：<pre class=" language-xml"><code class="language-xml">     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">></span></span>default<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.gif<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.css<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>*.js<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/images/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
         <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">></span></span>/upload/*<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">></span></span>
</code></pre>
</li>
<li>由spring对静态资源进行放行（spring默认无法处理没有路径映射的请求）<ol>
<li>使用spring自带的defaultServlet处理全部没有进行路径映射的请求（包括静态资源和其他不能识别的URL）：<pre class=" language-xml"><code class="language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mvc:</span>default-servlet-handler</span> <span class="token attr-name">default-servlet-name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>default<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
</code></pre>
 虽然名字叫defaultServlet，但其实不是servlet，而是<code>DefaultServletHttpRequestHandler</code>，是<code>DispatcherServlet</code>内部的一个<code>RequestHandler</code>，不能处理的请求都会交给它处理。默认名字是<code>default</code>。</li>
<li>映射请求和资源文件路径（没有路径映射，那就创建一个路径映射）：<pre class=" language-xml"><code class="language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mvc:</span>resources</span> <span class="token attr-name">mapping</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/img/**<span class="token punctuation">"</span></span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/img/<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">mvc:</span>resources</span> <span class="token attr-name">mapping</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/upload/**<span class="token punctuation">"</span></span> <span class="token attr-name">location</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/upload/<span class="token punctuation">"</span></span><span class="token punctuation">/></span></span>
</code></pre>
由spring放行静态资源文件有个弊端，静态资源的请求也会受到拦截器的影响，因此，拦截器中必要时需要放行静态资源。</li>
</ol>
</li>
</ol>
<h2 id="通过SPI免配置文件启动"><a href="#通过SPI免配置文件启动" class="headerlink" title="通过SPI免配置文件启动"></a>通过SPI免配置文件启动</h2><p>当然还有另一个方式来创建<code>DispatcherServlet</code>，使用SPI类加载机制。只需实现一个<code>WebApplicationInitializer</code>接口，在<code>void onStartup(ServletContext servletContext)</code>方法中定义好要做的事情即可。<code>tomcat-catalina</code>会根据<code>spring-web/META-INF/service</code>中的<code>javax.servlet.ServletContainerInitializer</code>，去执行<code>org.springframework.web.SpringServletContainerInitializer</code>类的<code>void onStartup(@Nullable Set&lt;Class&lt;?&gt;&gt; webAppInitializerClasses, ServletContext servletContext)</code>方法，tomcat会根据<code>SpringServletContainerInitializer</code>上注解的<code>HandlesTypes</code>，去搜寻所有的<code>WebApplicationInitializer</code>接口的实现类，并传递给<code>onStartUp</code>方法，然后执行<code>WebApplicationInitializer</code>接口中onStartUp方法，进行<code>DispatcherServlet</code>以及应用上下文、拦截器、过滤器等功能的初始化操作，以实现免web.xml启动spring-mvc。</p>
<p><code>WebApplicationInitializer</code>有一个抽象类<code>AbstractAnnotationConfigDispatcherServletInitializer</code>，一般情况只要实现以下三个方法即可：</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getRootConfigClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//指定spring的配置类</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">></span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getServletConfigClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//指定spring-mvc的配置类</span>
    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> String<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getServletMappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//指定映射到DispatcherServlet的URL</span>
</code></pre>
<h2 id="分发过程"><a href="#分发过程" class="headerlink" title="分发过程"></a>分发过程</h2><p><img src="/2019/03/27/spring-mvc——源码初探/20190402221611295_795.png" alt="spring-mvc原理"></p>
<h1 id="源码解读"><a href="#源码解读" class="headerlink" title="源码解读"></a>源码解读</h1><h2 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h2><p><img src="/2019/03/27/spring-mvc——源码初探/20190402223733870_6923.png" alt></p>
<p>最主要的是<code>HttpServletBean</code>、<code>FrameworkServlet</code>、<code>DispatcherServlet</code>这三个类。 <code>HttpServletBean</code>用来读取web.xml定义的param参数，重写了init方法，其中会调用<code>FrameworkServlet</code>实现的初始化应用上下文的操作。</p>
<h2 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h2><h2 id="DispatcherServlet初始化"><a href="#DispatcherServlet初始化" class="headerlink" title="DispatcherServlet初始化"></a>DispatcherServlet初始化</h2><p>如果构造时没有提供<code>WebApplicationContext</code>，则需要在init-param中指定<code>contextConfigLocation</code>，在<code>ServletDispatcher.init()</code>方法中，将会调用<code>WebApplicationContext</code>的初始化操作。</p>
<h2 id="DispatcherServlet处理请求"><a href="#DispatcherServlet处理请求" class="headerlink" title="DispatcherServlet处理请求"></a>DispatcherServlet处理请求</h2><p>毋庸置疑，处理请求是通过service方法进行。<code>DispatcherServlet</code>重写了service、doGet、doPost等一系列的方法，它们都会调用<code>processRequest</code>方法来处理请求。其中的service方法，默认情况下依然是调用<code>super.service</code>方法，根据请求自动调用doGet、doPost方法，只有在不能识别请求方式时，才会直接调用<code>processRequest</code>。<code>processRequest</code>调用<code>Dispatcher.doService</code>方法，然后调用<code>doDispatch</code>方法，核心的逻辑都在<code>doDispatch</code>方法中。</p>
<h2 id="doDispatch"><a href="#doDispatch" class="headerlink" title="doDispatch"></a>doDispatch</h2><p>首先检查是否是<code>multipart</code>格式的请求，如果是的会将会将<code>request</code>包装成新的<code>MultipartHttpServletRequest</code>类型：</p>
<pre class=" language-java"><code class="language-java">HttpServletRequest processedRequest <span class="token operator">=</span> request<span class="token punctuation">;</span><span class="token comment" spellcheck="true">//原request对象</span>
processedRequest <span class="token operator">=</span> <span class="token function">checkMultipart</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>然后便是根据请求，找到请求对应的<code>handler</code>。在我们寻常的web开发中，常见的就是<code>RequestMappingHandlerMapping</code>，即Http请求和<code>Controller</code>方法的映射关系，当然如果有其他诸如<code>header</code>、<code>consumer</code>之列的条件也必须匹配上。从<code>RequestMappingHandlerMapping</code>中取出符合要求的<code>HandlerExecutionChain</code>（处理器执行链，看名字就知道，里面的内容将会链式执行，其中包括了<code>interceptor</code>和<code>handler</code>）（<code>RequestMappingHandlerMapping</code>对应的<code>handler</code>是<code>HandlerMethod</code>类型）。</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> HandlerExecutionChain <span class="token function">getHandler</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlerMappings <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>HandlerMapping mapping <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerMappings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            HandlerExecutionChain handler <span class="token operator">=</span> mapping<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> handler<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> null<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>HandlerExecutionChain</code>主要内容是对应的<code>Controller</code>中的对应方法，以及符合URL条件的<code>interceptors</code>。<br><img src="/2019/03/27/spring-mvc——源码初探/20190407232102404_29270.png" alt="interceptors"><br>找到<code>handler</code>之后，再去匹配用于执行<code>handler</code>的<code>adapter</code>：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">protected</span> HandlerAdapter <span class="token function">getHandlerAdapter</span><span class="token punctuation">(</span>Object handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> ServletException <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>handlerAdapters <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>HandlerAdapter adapter <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlerAdapters<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>adapter<span class="token punctuation">.</span><span class="token function">supports</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> adapter<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ServletException</span><span class="token punctuation">(</span><span class="token string">"No adapter for handler ["</span> <span class="token operator">+</span> handler <span class="token operator">+</span>
            <span class="token string">"]: The DispatcherServlet configuration needs to include a HandlerAdapter that supports this handler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>对于<code>HandlerMethod</code>而言，其对应的<code>adapter</code>为<code>RequestMappingHandlerAdapter</code>。<br><code>handler</code>只负责方法定义，而<code>adapter</code>则是这些方法的参数供给者、方法使用者。<code>adapter</code>会将<code>request</code>请求转换为<code>handle</code>方法所需要的参数，比如<code>QueryParam</code>、<code>PathVariable</code>、<code>CookieValue</code>等参数。<br>接下去，判断请求类型，如果是<code>GET</code>类型，将会判断<code>checkNotModified</code>，此操作同样是由<code>adapter</code>执行，而<code>handler</code>只负责提供<code>modify</code>的计算的方法：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">boolean</span> isGet <span class="token operator">=</span> <span class="token string">"GET"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isGet <span class="token operator">||</span> <span class="token string">"HEAD"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">long</span> lastModified <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">getLastModified</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ServletWebRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">checkNotModified</span><span class="token punctuation">(</span>lastModified<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isGet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>最后，就要开始执行<code>handler</code>了：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mappedHandler<span class="token punctuation">.</span><span class="token function">applyPreHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

<span class="token comment" spellcheck="true">// Actually invoke the handler.</span>
mv <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>asyncManager<span class="token punctuation">.</span><span class="token function">isConcurrentHandlingStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">applyDefaultViewName</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
mappedHandler<span class="token punctuation">.</span><span class="token function">applyPostHandle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>首先执行的是<code>interceptor</code>的前置方法<code>preHandle</code>：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">boolean</span> <span class="token function">applyPreHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>
    HandlerInterceptor<span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ObjectUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> interceptors<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            HandlerInterceptor interceptor <span class="token operator">=</span> interceptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>interceptor<span class="token punctuation">.</span><span class="token function">preHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> null<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>可以看出，执行方式是很简单粗暴的，直接遍历全部的<code>interceptor</code>，当然这些拦截器已经根据优先级排序过了。<code>preHandler</code>是可拦截方法执行的，当其返回<code>false</code>时，被拦截的方法无法执行，此时，将会直接执行<code>afterCompletion</code>方法。当然，interceptor会通过<code>interceptorIndex</code>记录最后一次执行成功的<code>interceptor</code>的索引。执行<code>afterCompletion</code>时，将从索引位置开始，逆序执行<code>interceptor</code>，这就决定了，只有执行过<code>preHandle</code>的<code>interceptor</code>才会执行<code>afterCompletion</code>：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">triggerAfterCompletion</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> Exception ex<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>

    HandlerInterceptor<span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ObjectUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>interceptorIndex<span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            HandlerInterceptor interceptor <span class="token operator">=</span> interceptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                interceptor<span class="token punctuation">.</span><span class="token function">afterCompletion</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"HandlerInterceptor.afterCompletion threw exception"</span><span class="token punctuation">,</span> ex2<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果所有的<code>preHandle</code>方法全部通过了，先检查请求方式是否支持，对，<code>checkRequest(request);</code>是在preHandler之后才执行的。</p>
<p>然后才开始开始执行<code>controller</code>的方法，这个过程会用到两个重要的<code>Resolver</code>，<code>HandlerMethodArgumentResolverComposite</code>和<code>HandlerMethodReturnValueHandlerComposite</code>，分别用于解析参数和返回结果。<br><img src="/2019/03/27/spring-mvc——源码初探/20190429163142488_18502.png" alt="参数解析器"></p>
<p>参数解析器有接近30个，请求参数、路径参数、header属性、request属性、cookie属性、session属性等，还有使用<code>body</code>推送的<code>json</code>等数据，都有对应的解析器。</p>
<p>要注意的是解析器只负责将请求中可以用的参数提取出来，但是绑定到开发者定义的<code>JavaBean</code>模型上是由<code>DataBinder</code>去做的。</p>
<p>方法执行后得到的返回值并不能直接被使用，<code>spring</code>会使用返回值解析器对这些返回值做二次处理（兼容处理）。</p>
<pre class=" language-java"><code class="language-java">    <span class="token keyword">this</span><span class="token punctuation">.</span>returnValueHandlers<span class="token punctuation">.</span><span class="token function">handleReturnValue</span><span class="token punctuation">(</span>
                    returnValue<span class="token punctuation">,</span> <span class="token function">getReturnValueType</span><span class="token punctuation">(</span>returnValue<span class="token punctuation">)</span><span class="token punctuation">,</span> mavContainer<span class="token punctuation">,</span> webRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>可以看出内置的对返回值的处理器有很多个：</p>
<p><img src="/2019/03/27/spring-mvc——源码初探/20190408092836181_9039.png" alt></p>
<p>但是不管是何种返回值，<code>handle</code>方法执行后都需要需要得到<code>ModelAndView</code>类型的结果，这样并不是说<code>Controller</code>方法返回<code>ModelAndView</code>对象就是最好的，不管有没有返回这种类型，方法执行后都会重新创建<code>ModelAndView</code>对象：</p>
<pre class=" language-java"><code class="language-java">mv <span class="token operator">=</span> ha<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">.</span><span class="token function">getHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<pre class=" language-java"><code class="language-java"><span class="token keyword">private</span> ModelAndView <span class="token function">getModelAndView</span><span class="token punctuation">(</span>ModelAndViewContainer mavContainer<span class="token punctuation">,</span>
            ModelFactory modelFactory<span class="token punctuation">,</span> NativeWebRequest webRequest<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>

    modelFactory<span class="token punctuation">.</span><span class="token function">updateModel</span><span class="token punctuation">(</span>webRequest<span class="token punctuation">,</span> mavContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mavContainer<span class="token punctuation">.</span><span class="token function">isRequestHandled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> null<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ModelMap model <span class="token operator">=</span> mavContainer<span class="token punctuation">.</span><span class="token function">getModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ModelAndView mav <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModelAndView</span><span class="token punctuation">(</span>mavContainer<span class="token punctuation">.</span><span class="token function">getViewName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> model<span class="token punctuation">,</span> mavContainer<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mavContainer<span class="token punctuation">.</span><span class="token function">isViewReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mav<span class="token punctuation">.</span><span class="token function">setView</span><span class="token punctuation">(</span><span class="token punctuation">(</span>View<span class="token punctuation">)</span> mavContainer<span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token keyword">instanceof</span> <span class="token class-name">RedirectAttributes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> <span class="token operator">?</span><span class="token operator">></span> flashAttributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>RedirectAttributes<span class="token punctuation">)</span> model<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getFlashAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        HttpServletRequest request <span class="token operator">=</span> webRequest<span class="token punctuation">.</span><span class="token function">getNativeRequest</span><span class="token punctuation">(</span>HttpServletRequest<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            RequestContextUtils<span class="token punctuation">.</span><span class="token function">getOutputFlashMap</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>flashAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mav<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当然，并不是所有请求都是需要视图的。如果确实是非<code>REST</code>请求，需要使用视图的，将会使用<code>getModelAndView</code>方法创建该类型结果，当然如果不需要使用视图，将直接返回null。</p>
<p>然后会判断方法是否异步，异步则直接返回，否则自行后置处理方法，与<code>completion</code>处理非常类似：</p>
<pre class=" language-java"><code class="language-java"><span class="token keyword">void</span> <span class="token function">applyPostHandle</span><span class="token punctuation">(</span>HttpServletRequest request<span class="token punctuation">,</span> HttpServletResponse response<span class="token punctuation">,</span> <span class="token annotation punctuation">@Nullable</span> ModelAndView mv<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> Exception <span class="token punctuation">{</span>

        HandlerInterceptor<span class="token punctuation">[</span><span class="token punctuation">]</span> interceptors <span class="token operator">=</span> <span class="token function">getInterceptors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ObjectUtils<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>interceptors<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> interceptors<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                HandlerInterceptor interceptor <span class="token operator">=</span> interceptors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                interceptor<span class="token punctuation">.</span><span class="token function">postHandle</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">,</span> mv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>就要开始渲染视图了，渲染完成之后，再执行<code>triggerAfterCompletion</code>方法，所以<code>completion</code>方法的执行时机是请求结束之后（这个时候客户端的请求已经完成了）。</p>
<pre class=" language-java"><code class="language-java"><span class="token function">processDispatchResult</span><span class="token punctuation">(</span>processedRequest<span class="token punctuation">,</span> response<span class="token punctuation">,</span> mappedHandler<span class="token punctuation">,</span> mv<span class="token punctuation">,</span> dispatchException<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>finally块中会做异步请求的<code>completion</code>处理。</p>
<p>至此，分发工作完成。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://thas.cc/2019/03/27/spring——源码初探/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Thas">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ThasBlog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/27/spring——源码初探/" itemprop="url">spring——源码初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-27T14:53:52+08:00">
                2019-03-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/源码解读/" itemprop="url" rel="index">
                    <span itemprop="name">源码解读</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="spring-core"><a href="#spring-core" class="headerlink" title="spring-core"></a>spring-core</h2><p>spring框架的核心包为spring-core，其内部结构如下图：</p>
<p><img src="/2019/03/27/spring——源码初探/20190401114608854_28132.png" alt></p>
<p>其中包括了asm字节码操作支持、cglib代理支持、lang（NotNull）类型限定支持、objenesis对象实例化支持，自用的util工具类库，以及对spring框架的核心类库支持core：</p>
<p><img src="/2019/03/27/spring——源码初探/20190401114957827_31033.png" alt></p>
<p>从子包来看，核心类库主要包括annotation注解、codec编解码、convert类型转换、env环境配置、io操作、log日志、serializer序列化工具（使用java自带的）、style字符串输出美化、task（定时/异步/同步）任务调度、type（Java反射类型）。</p>
<p>其实spring-core还有一个依赖的spring-jcl，其只是集成了<code>commons-logging</code>提供的日志规范，内部依赖的是slf4j日志框架，并适配了log4j日志框架。如果缺少依赖将使用NoOpLog，所有日志输出都会忽略。（比较常见的一种自定义日志框架思路）。</p>
<h2 id="spring-expression"><a href="#spring-expression" class="headerlink" title="spring-expression"></a>spring-expression</h2><p>提供SpEl表达式的支持。${}只能替换字符串，#{}可以执行运算和方法</p>
<h2 id="spring-bean"><a href="#spring-bean" class="headerlink" title="spring-bean"></a>spring-bean</h2><p>提供BeanFactory和FactoryBean的规范。</p>
<ul>
<li>BeanFactory是bean的生产工厂，spring容器就是基于此来实现的。</li>
<li>FactoryBean是用来创建特定bean实例的工厂，为融合进spring框架的其他插件提供规范，比如Mybatis就实现了<code>SqlSessionFactoryBean</code>，用于创建<code>SqlSessionFactory</code>的实例。</li>
</ul>
<h2 id="spring-aop"><a href="#spring-aop" class="headerlink" title="spring-aop"></a>spring-aop</h2><p>aop切面编程所依赖的包，spring-aop整合进了aop联盟的标准类库，所以实际使用并不需要导入aopalliance包。spring提供了切面编程所需要的interceptor拦截器和advisor通知器以及代理创建工厂。spring-aop需要创建代理和注入代理对象，因此其依赖spring-core和spring-bean。</p>
<p>需要注意的是，spring-aop是为用户提供的：</p>
<ul>
<li>spring-aop是不依赖aspectj的，在spring-context中提供了对aspectj的支持，通过<code>EnableAspectJAutoProxy</code>使用aspectj提供的aop，aspect、around、after这些比较高级的切面编程用法都是由aspectj提供的</li>
<li>spring-tx虽然也是属于切面编程，但是其并不依赖spring-aop，自己实现了一套切面代理。</li>
<li>spring-mvc中的interceptor不属于切面编程。</li>
</ul>
<h2 id="spring-context"><a href="#spring-context" class="headerlink" title="spring-context"></a>spring-context</h2><p>这个就比较牛逼了，内容非常多，包括cache缓存、context应用上下文、jmx管理扩展、remoting远程调用、scheduling定时任务、scripting脚本引擎、validation数据验证、stereotype容器注入注解、还有ui所需的数据模型ModelMap（<code>BindingAwareModelMap</code>在validation中）。这里的ui、model并非就单单是指web中的ui和模型。</p>
<p><img src="/2019/03/27/spring——源码初探/20190401160734309_1876.png" alt></p>
<h2 id="spring-context-support"><a href="#spring-context-support" class="headerlink" title="spring-context-support"></a>spring-context-support</h2><p>spring-context的扩展支持，注意是定时任务和freemarker支持。freemarker不仅仅只是web视图引擎。</p>
<h2 id="spring-tx"><a href="#spring-tx" class="headerlink" title="spring-tx"></a>spring-tx</h2><p>spring事务支持。分别对dao和jca进行了实现。</p>
<h2 id="spring-jdbc"><a href="#spring-jdbc" class="headerlink" title="spring-jdbc"></a>spring-jdbc</h2><p>jdbc支持。依赖spring-tx，以实现DataSourceTransactionManager，数据源的事务管理支持。</p>
<h2 id="spring-web"><a href="#spring-web" class="headerlink" title="spring-web"></a>spring-web</h2><p>web连接方面的支持，其只依赖spring-core和spring-bean</p>
<h2 id="spring-webmvc"><a href="#spring-webmvc" class="headerlink" title="spring-webmvc"></a>spring-webmvc</h2><p>webmvc框架支持，其使用spring-web实现web通信，使用spring-context进行web应用上下文管理。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Thas</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Thas</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"debug":false,"model":{"jsonPath":"live2d-widget-model-wanko"},"display":{"width":150,"height":300,"position":"right","hOffset":0,"vOffset":-200},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
